---
- name: postgresql database
  hosts: all
  sudo: true
  tasks:

  - apt: pkg=$item state=present
    with_items:
    - postgresql
    - libpq-dev        # for ansible
    - python-psycopg2  # for ansible

  - set_fact: normal_user={{ lookup('env','USER') }}
    sudo: false
 
  - set_fact: normal_user_home={{ lookup('env','HOME') }}
    sudo: false

  - name: create postgresql role for normal user
    shell: sudo -u postgres createuser --superuser --echo $normal_user && 
           touch $normal_user_home/.postgresql_role_created
           creates=$normal_user_home/.postgresql_role_created

  - name: create postgresql db for normal user
    shell: sudo -u postgres createdb --encoding=UTF8 --echo $normal_user && 
           touch $normal_user_home/.postgresql_db_created
           creates=$normal_user_home/.postgresql_db_created

